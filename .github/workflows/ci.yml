name: CI

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  dogfood:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Dogfood the setup-rbmt action
        id: setup
        uses: ./.github/actions/setup-rbmt
        with:
          toolchains: 1.85.0
          rbmt-version: ${{ github.sha }}

      - name: Run lint on workspace
        run: cargo +${{ steps.setup.outputs.nightly-version }} rbmt --lock-file existing lint

      - name: Build documentation (stable)
        run: cargo +${{ steps.setup.outputs.stable-version }} rbmt --lock-file existing docs

      - name: Build documentation (docs.rs / nightly)
        run: cargo +${{ steps.setup.outputs.nightly-version }} rbmt --lock-file existing docsrs

      - name: Run tests with stable (existing lock)
        run: cargo +${{ steps.setup.outputs.stable-version }} rbmt --lock-file existing test stable

      - name: Run tests with nightly (existing lock)
        run: cargo +${{ steps.setup.outputs.nightly-version }} rbmt --lock-file existing test nightly

      - name: Run tests with MSRV (existing lock)
        run: cargo +1.85.0 rbmt --lock-file existing test msrv

      - name: Run tests with stable (recent dependencies)
        run: cargo +${{ steps.setup.outputs.stable-version }} rbmt --lock-file recent test stable

      - name: Run tests with stable (minimal dependencies)
        run: cargo +${{ steps.setup.outputs.stable-version }} rbmt --lock-file minimal test stable
